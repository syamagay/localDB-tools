#!/usr/bin/env python3
#################################
# Author: Arisa Kubota
# Email: arisa.kubota at cern.ch
# Date: July 2019
# Project: Local Database for YARR
#################################

# Common
import os
import sys
import shutil
import requests
import json
import signal

import argparse 
import yaml     # Read YAML config file

from getpass    import getpass
from pymongo    import MongoClient, errors

sys.path.append(os.path.join(os.path.dirname(os.path.abspath(__file__)),'../lib/localdb-tools/modules'))

def readConfig(conf_path):
    f = open(conf_path, 'r')
    conf = yaml.load(f)
    return conf

def getArgs():
    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    parser.add_argument("command", help="Command option", type=str, nargs='+')
    parser.add_argument('-f', '--config', help='Provide path to connectivity config file\nand retrieve config files following the config.', type=str)
    parser.add_argument('-u', '--user', help='Set the name of the user.', type=str)
    parser.add_argument('-s', '--site', help='Set the name of the site.', type=str)
    parser.add_argument('-b', '--before', help='Set chip config type "before".', action='store_true')
    parser.add_argument('-a', '--after', help='Set chip config type "after".', action='store_true')
    parser.add_argument('-D', '--dummy', help='Set dummy data "True".', action='store_true')
    parser.add_argument('--serialnumber', help='Provide serial number of Module\nand retrieve config files of the latest scan for the Module.', type=str)
    parser.add_argument('--runid', help='Provide run ID.', type=str)

    parser.add_argument('-d', '--directory', help='Provide directory name.', type=str)

    args = parser.parse_args()

    if args.config is not None:
        conf = readConfig(args.config)    # Read from config file
        if 'config' in conf:
            if 'serialnumber' in conf['config']:  args.serialnumber = conf['config']['serialnumber']
            if 'runid'        in conf['config']:  args.runid        = conf['config']['runid']
            if 'directory'    in conf['config']:  args.directory    = conf['config']['directory']
        if 'testdata' in conf:
            if 'serialnumber' in conf['testdata']:  args.serialnumber = conf['testdata']['serialnumber']
    return args

def __init():
    db_path = os.environ['HOME']+'/.yarr/localdb/.retrieve'
    if not os.path.isdir( db_path ): 
        os.mkdir( db_path )
#    head_path = db_path+'/HEAD'
#    head_file = open(head_path, 'w')
#    head_file.close()
#    config_path = db_path+'/config'
#    config_file = open(config_path, 'w')
#    config_file.close()
    sys.exit()

def __check():
    db_path = os.environ['HOME']+'/.yarr/localdb/.retrieve'
    if not os.path.isdir( db_path ): 
        print('ERROR: Not exist a retrieve repository, do "localdbtool-retrieve init" to initialize')
        sys.exit()

def __network_db(url):
    global authentication
    authentication = False
    max_server_delay = 1
    client = MongoClient(url, serverSelectionTimeoutMS=max_server_delay)
    try:
        client.server_info()
        print('SUCCESS: The connection of Local DB {} is GOOD.\n'.format(url))
        return True
    except errors.ServerSelectionTimeoutError as err:
        print('WARNING: The connection of Local DB {} is BAD.'.format(url))
        print('         {}\n'.format(err))
        return False
    except errors.OperationFailure as err:
        print('Need users authenticated.')

    try:
        global user
        user = input('User name > ')
        global pwd
        pwd = getpass('Password > ')
        db = client['localdb']
        try:
            db.authenticate(user, pwd)
            print('SUCCESS: The connection of Local DB {} is GOOD.\n'.format(url))
            authentication = True
            return True
        except errors.OperationFailure as err: 
            print('ERROR: Authentication failed.')
            sys.exit()
    except KeyboardInterrupt:
        print('')
        sys.exit()

def __network_viewer(url):
    try:
        response = requests.get(url)
        if response.status_code == 200:
            print('SUCCESS: The connection of Viewer Application {} is GOOD.\n'.format(url))
            return True
        else:
            print('WARNING: Something wrong in the page {}.\n'.format(url))
            return False
    except Exception as err:
        print('WARNING: The connection of Viewer Application {} is BAD.'.format(url))
        print('         {}\n'.format(err))
        return False

def __remote(remote_name='None'):
    db_path = os.environ['HOME']+'/.yarr/localdb/.retrieve'
    head_path = db_path+'/HEAD'
    if not os.path.isfile(head_path):
        print('ERROR: Not registered remote repository yet.') 
        print('')
        print('(use "remote add <name>" to make the remote repository.)')
        sys.exit()
    head_file = open(head_path, 'r')
    head_data = yaml.load(head_file, Loader=yaml.SafeLoader)
    config_path = db_path+'/config'
    config_file = open(config_path, 'r+')
    config_data = yaml.load(config_file, Loader=yaml.SafeLoader)

    if remote_name=='None':
        remote = head_data['remote'] 
        print('--- remotes ---')
        for remote_data in config_data['remote']:
            if remote_data == remote: print('* {}'.format(remote_data))
            else: print('  {}'.format(remote_data))
        print('---------------')
    else:
        remote = remote_name
    if not remote in config_data['remote']:
        print('ERROR: Could not read "{}" from remote repository.'.format(remote))
        print('')
        print('(use "remote add <name>" to make the remote repository.)')
        sys.exit()

    db_url = config_data['remote'][remote]['db']
    viewer_url = config_data['remote'][remote]['viewer']
    print('Check remote status ...')
    print('')
    print('remote: {}'.format(remote))
    print('')
    print('- DB URL: {}'.format(db_url))
    print('[Connection Test]')
    __network_db(db_url)
    print('- Viewer URL: {}'.format(viewer_url))
    print('[Connection Test]')
    __network_viewer(viewer_url)

    sys.exit()

def __remote_add(remote_name=None):
    if not remote_name:
        print('Usage: remote add <name>')
        sys.exit()
    db_path = os.environ['HOME']+'/.yarr/localdb/.retrieve'
    config_path = db_path+'/config'
    config_data = { 'remote': {} }
    if os.path.isfile(config_path):
        config_file = open(config_path, 'r+')
        config_data = yaml.load(config_file, Loader=yaml.SafeLoader)
        if remote_name in config_data['remote']:
            print('ERROR: Remote "{}" already exists.\n'.format(remote_name))
            sys.exit()
    else:
        config_file = open(config_path, 'w')

    try:
        print('Create remote repostiory "{}"'.format(remote_name))
        print('')
        db_url = input('Enter the URL of DB Server (e.g. mongodb://127.0.0.1:27017/), or "None" if not to be set.\n')
        print('[Connection Test]')
        db_connection = __network_db(db_url)
        viewer_url = input('Enter the URL of the Viewer Application (e.g. http://127.0.0.1:5000/localdb/), or "None" if not to be set.\n')
        print('[Connection Test]')
        viewer_connection = __network_viewer(viewer_url)

        print('  remote: {}'.format(remote_name))
        print('  DB Server: {0:<30}  (connection: {1})'.format(db_url, db_connection))
        print('  Viewer: {0:<30}     (connection: {1}) '.format(viewer_url, viewer_connection))
        print('')
        answer = input('Are you sure that is correct? [y/n]\n')
        print('')
        if answer.lower() == 'y':
            head_path = db_path+'/HEAD'
            if not os.path.isfile(head_path):
                head_file = open(head_path, 'w')
                head_data = { 'remote': remote_name }
                head_file.write(yaml.dump(head_data, default_flow_style=False))
                head_file.close()
            config_data['remote'].update({
                remote_name:{
                    'db': db_url,
                    'viewer': viewer_url
                }
            })
            config_file.write(yaml.dump(config_data, default_flow_style=False))
            config_file.close()
            ref_path = db_path+'/refs/remotes'
            if not os.path.isdir(ref_path): 
                os.makedirs(ref_path)
            remote_path = db_path+'/refs/remotes/'+remote_name
            remote_file = open(remote_path, 'w')
            remote_file.close()
        sys.exit()
    except KeyboardInterrupt:
        print('***interrupted***')
        sys.exit()

def __status():
    db_path = os.environ['HOME']+'/.yarr/localdb/.retrieve'
    head_path = db_path+'/HEAD'
    remote = None
    branch = None
    config_data = {'remote':{}}
    remote_data = ['']
    if os.path.isfile(head_path):
        head_file = open(head_path, 'r')
        head_data = yaml.load(head_file, Loader=yaml.SafeLoader)
        if 'remote' in head_data: remote=head_data['remote']
        if 'branch' in head_data: branch=head_data['branch']
        config_path = db_path+'/config'
        config_file = open(config_path, 'r')
        config_data = yaml.load(config_file, Loader=yaml.SafeLoader)
    if remote:
        remote_path = db_path+'/refs/remotes/'+remote
        remote_file = open(remote_path, 'r')
        remote_data = remote_file.read().split('\n')
        remote_file.close()

    print('--- remote ---')
    if config_data['remote']=={}: print('  None')
    else:
        for remote_name in config_data['remote']:
            if remote_name==remote: print('* {}'.format(remote_name))
            else: print('  {}'.format(remote_name))
    print('--- branch ---')
    if remote_data==['']: print('  None')
    else:
        for branch_name in remote_data:
            if branch_name==branch: print('* {}'.format(branch_name))
            else: print('  {}'.format(branch_name))
    sys.exit()
 
def retrieve():
    args = getArgs()
    command = args.command[0]
    nargs = len(args.command)-1
    first_arg = None
    second_arg = None
    if nargs == 1: 
        first_arg = args.command[1]
    elif nargs == 2: 
        first_arg = args.command[1]
        second_arg = args.command[2]
        if command == 'fetch':
            print('ERROR: Unknown subcommand: {}'.format(second_arg))
    elif not nargs == 0:
        print('ERROR: Unknown subcommand: {}'.format(args.command[3]))
        print('Usage: {} <remote>'.format(command))
        if not command == 'fetch':
            print('   or: {} <serial number>'.format(command))
            print('    or {} <remote> <serial number>'.format(command))
        if command == 'checkout':
            print('   or: {} <test data id>'.format(command))
        sys.exit()

    commands = [ 'init', 'status', 'remote', 'fetch', 'log', 'checkout' ]
    if not command in commands:
        print('ERROR: Unknown command: "{}". See "--help".'.format(command))
        sys.exit()

    if command == 'init': __init()

    __check()

    if command=='remote':
        if not first_arg: __remote()
        elif first_arg=='add': __remote_add(second_arg)
        elif first_arg=='status': __remote(second_arg)
        else:
            print('ERROR: Unknown subcommand: {}'.format(first_arg))
            print('Usage: remote status <name>')
            print('   or: remote add <name>')
            sys.exit()
    elif command == 'status': __status()
   
    db_path = os.environ['HOME']+'/.yarr/localdb/.retrieve'

    head_path = db_path+'/HEAD'
    if not os.path.isfile(head_path):
        print('ERROR: Not registered remote repository yet.') 
        print('')
        print('(use "remote add <name>" to make the remote repository.)')
        sys.exit()
    head_file = open(head_path, 'r')
    head_data = yaml.load(head_file, Loader=yaml.SafeLoader)
    head_file.close()

    config_path = db_path+'/config'
    config_file = open(config_path, 'r')
    config_data = yaml.load(config_file, Loader=yaml.SafeLoader)
    remote = None

    if first_arg:
        if second_arg and first_arg in config_data['remote']:
            remote = first_arg
        elif not second_arg:
            if first_arg in config_data['remote']:
                remote = first_arg
        else:
            print('ERROR: Unknown subcommand: {}'.format(first_arg))
            print('Usage: {} <remote>'.format(command))
            if not command == 'fetch':
                print('   or: {} <serial number>'.format(command))
                print('   or: {} <remote> <serial number>'.format(command))
            if command == 'checkout':
                print('   or: {} <test data id>'.format(command))
            sys.exit()
    if not remote:
        if head_data and 'remote' in head_data:
            remote = head_data['remote']
        else:
            print('ERROR: Not registered remote repository yet.') 
            print('')
            print('(use "remote add <remote name>" to make the remote repository.)')
            sys.exit()

    if __network_db(config_data['remote'][remote]['db']): 
        import direct as function
        function.url = config_data['remote'][remote]['db']
        global authentication
        global user
        global pwd
        if authentication:
            function.authentication = authentication
            function.user = user
            function.pwd = pwd
    elif __network_viewer(config_data['remote'][remote]['viewer']): 
        import indirect as function
        function.url = config_data['remote'][remote]['viewer']
    else:
        print('ERROR: Cannot access Local DB by remote {}'.format(remote))
        print('       Try later or by another remote')
        sys.exit()

    if command == 'fetch': function.__fetch(args, remote) 

    remote_path = db_path+'/refs/remotes/'+remote
    remote_file = open(remote_path, 'r')
    remote_data = remote_file.read().split('\n')
    branch = None
    option = None
    if first_arg:
        if second_arg:
            if second_arg in remote_data:
                branch = second_arg
            else:
                print('ERROR: Not found component data "{0}" in remote "{1}".'.format(branch, remote))
                print('')
                print('(use "fetch <remote> to update component data.)')
                sys.exit()
        else:
            if not remote==first_arg:
                if first_arg in remote_data:
                    branch = first_arg
                else:
                    option = first_arg

    if command == 'checkout': 
        if not branch and 'branch' in head_data:
            branch = head_data['branch']
        function.__checkout(args, branch, option)
        head_file = open(head_path, 'w')
        head_data = { 
            'remote': remote,
            'branch': branch
        }
        head_file.write(yaml.dump(head_data, default_flow_style=False))
        head_file.close()
    elif command == 'log': function.__log(args, branch)

if __name__ == '__main__': retrieve()
